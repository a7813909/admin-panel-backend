import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
import prisma from '../db'; // ‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç Prisma
import { Prisma } from '@prisma/client'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø—ã Prisma
import config from '../config';


import { DecodedUser,  AuthRequest } from '../types/auth-types'; 


// 1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ JWT_SECRET_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Ç–≤–æ–µ–º .env
const JWT_SECRET = config.jwtSecret; 

// ----------------------------------------------------------------------
// --- 2. MIDDLEWARE: –ó–ê–©–ò–¢–ê (–ü–†–û–í–ï–†–ö–ê JWT –ò –ë–î) ---
// ----------------------------------------------------------------------

export const protect = async (req: AuthRequest, res: Response, next: NextFunction) => {
  let token: string = '';
  let decoded: DecodedUser; // üî• –¢–µ–ø–µ—Ä—å –¢–∞–π–ø—Å–∫—Ä–∏–ø—Ç –∑–Ω–∞–µ—Ç, —á—Ç–æ —Ç–∞–∫–æ–µ DecodedUser!

  // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization
  if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {
    try {
      token = req.headers.authorization.split(' ')[1]; // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω

      // 2. –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω
      // –ó–¥–µ—Å—å jwt.verify() –º–æ–∂–µ—Ç –±—Ä–æ—Å–∏—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
      decoded = jwt.verify(token, JWT_SECRET) as DecodedUser;

    } catch (error) {
       // –û—à–∏–±–∫–∞ —Ç–æ–∫–µ–Ω–∞ (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω, –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –ø–æ–¥–¥–µ–ª–∞–Ω)
       console.error('JWT Verification Failed:', error);
       return res.status(401).json({
         message: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω.',
       });
    }
  } else {
    // –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    return res.status(401).json({
      message: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –¢–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'
    });
  }

  // üö® –ö–†–ò–¢–ò–ß–ù–´–ô –®–ê–ì: –ü–†–û–í–ï–†–ö–ê –°–£–©–ï–°–¢–í–û–í–ê–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ò –ï–ì–û –ê–ö–¢–£–ê–õ–¨–ù–û–ô –†–û–õ–ò –í –ë–î
  // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω –∏–ª–∏ –µ–≥–æ —Ä–æ–ª—å –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –º—ã —ç—Ç–æ –æ—Ç–ª–æ–≤–∏–º.
  try {
     const currentUserFromDb = await prisma.user.findUnique({
         where: { id: decoded.userId }, // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ—Ä–µ–º –∏–∑ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
         select: { id: true, email: true, role: true } // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ –ë–î
     });

     if (!currentUserFromDb) {
         // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –≤ —Ç–æ–∫–µ–Ω–µ, –Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –ë–î ("–ó–æ–º–±–∏-—Ç–æ–∫–µ–Ω")
         return res.status(401).json({ message: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –£—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∞.' });
     }
     
     // 3. üéØ –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –ê–ö–¢–£–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –∫ –æ–±—ä–µ–∫—Ç—É –∑–∞–ø—Ä–æ—Å–∞ `req.user`
     // (–≠—Ç–æ –≤–∞–∂–Ω–æ, –µ—Å–ª–∏ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å –º–æ–º–µ–Ω—Ç–∞ –≤—ã–¥–∞—á–∏ —Ç–æ–∫–µ–Ω–∞)
     req.user = currentUserFromDb;

     // üî• –í—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
     // console.log('User from DB attached to request (protect middleware):', req.user);

     next(); // –ü–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–º—É –º–∏–¥–ª–≤–∞—Ä—É –∏–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É

  } catch (error) {
      // –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º)
      console.error('Database check failed during protection:', error);
      return res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.' });
  }
};

// ----------------------------------------------------------------------
// --- 3. MIDDLEWARE: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–ü–†–û–í–ï–†–ö–ê –†–û–õ–ò) ---
// ----------------------------------------------------------------------

export const authorize = (requiredRoles: string[]) => { // requiredRoles - —ç—Ç–æ –º–∞—Å—Å–∏–≤ —Ä–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø

  return (req: AuthRequest, res: Response, next: NextFunction) => {
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–æ–±—â–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å —Ä–æ–ª—å
    //    (req.user –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω –º–∏–¥–ª–≤–∞—Ä–æ–º protect)
    if (!req.user || !req.user.role) {
        console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: req.user –∏–ª–∏ –µ–≥–æ —Ä–æ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω–æ, protect –º–∏–¥–ª–≤–∞—Ä –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª –∏–ª–∏ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞.');
        // –ï—Å–ª–∏ auth.middleware.ts –∏–¥–µ—Ç –ø–æ—Å–ª–µ protect, —Ç–æ 401 –æ—à–∏–±–∫–∞ –∑–¥–µ—Å—å –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —é–∑–µ—Ä –Ω–µ –ø—Ä–æ—à–µ–ª protect –∏–ª–∏ —É–¥–∞–ª–µ–Ω
        return res.status(401).json({ message: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.' });
    }

    // 2. –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ req.user
    const userRole = req.user.role;

    // üî• –í—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
    console.log('--- Authorize Middleware Debug ---');
    console.log('User role in authorize middleware:', userRole);
    console.log('Required roles for this route:', requiredRoles);

    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –û–î–ù–ê –ò–ó —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ä–æ–ª–µ–π
    const hasRequiredRole = requiredRoles.includes(userRole);

    // üî• –í—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:
    console.log('Does user have required role?', hasRequiredRole);

    if (hasRequiredRole) {
      // üî•üî•üî• –ï–°–õ–ò –£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ï–°–¢–¨ –ù–ï–û–ë–•–û–î–ò–ú–ê–Ø –†–û–õ–¨, –†–ê–ó–†–ï–®–ê–ï–ú –î–û–°–¢–£–ü! üî•üî•üî•
      next();
    } else {
      // üî•üî•üî• –ï–°–õ–ò –ù–ï–¢ –ù–ï–û–ë–•–û–î–ò–ú–û–ô –†–û–õ–ò, –û–¢–ö–ê–ó–´–í–ê–ï–ú –í –î–û–°–¢–£–ü–ï! üî•üî•üî•
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å –∫–æ—Å—ã–º–∏ –∫–∞–≤—ã—á–∫–∞–º–∏
      return res.status(403).json({
          message: `–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è —Ä–æ–ª–∏: ${requiredRoles.join(', ')}. –í–∞—à–∞ —Ä–æ–ª—å: ${userRole}.`
      });
    }
  };
};