import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
// –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à alias @config, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, 
// –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–π '../config'
import config from '../config';

// --- 1. –¢–ò–ü–ò–ó–ê–¶–ò–Ø ---

// –¢–∏–ø—ã –¥–ª—è –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å AuthController)
export interface DecodedUser {
  userId: string; // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UUID)
  email: string;
  role: string;   // –†–æ–ª—å: 'ADMIN', 'USER' –∏ —Ç.–¥.
  iat?: number;
  exp?: number;
}

// –†–∞—Å—à–∏—Ä—è–µ–º Request –¥–ª—è TS, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å req.user
export interface AuthRequest extends Request {
  user?: DecodedUser;
}


// –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å fallbacks)
const JWT_SECRET = config.jwtSecret;

// ----------------------------------------------------------------------
// --- 2. MIDDLEWARE: –ó–ê–©–ò–¢–ê (–ü–†–û–í–ï–†–ö–ê JWT) ---
// ----------------------------------------------------------------------

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JWT –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization.
 * –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (userId, role) –∫ req.user.
 */
export const protect = (req: AuthRequest, res: Response, next: NextFunction) => {
  let token: string = '';

  // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫: 'Authorization: Bearer <token>'
  if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {
    try {
      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω (—É–±–∏—Ä–∞–µ–º "Bearer ")
      token = req.headers.authorization.split(' ')[1];

      // 2. –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω (–ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å –∏ —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏)
      const decoded = jwt.verify(token, JWT_SECRET) as DecodedUser;

      // 3. üéØ –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫ –∑–∞–ø—Ä–æ—Å—É
      req.user = decoded;

      next(); // –ó–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ

    } catch (error) {
      // –û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω (–ø–æ–¥–ø–∏—Å—å –∫—Ä–∏–≤–∞—è –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω)
      console.error('JWT Verification Failed:', error);
      // 2. [–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û] –í—ã–≤–æ–¥–∏–º —Ç–æ–∫–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –æ–Ω –Ω–µ –æ–±—Ä–µ–∑–∞–Ω:
    console.log('Tried Token:', token); 

    // 3. –°–Ω–æ–≤–∞ –≤—ã–≤–æ–¥–∏–º –°–µ–∫—Ä–µ—Ç (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑):
    console.log('Using Secret:', JWT_SECRET);
      return res.status(401).json({
        message: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω.',
      });
    }
  } else {
    // –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    return res.status(401).json({
      message: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –¢–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'
    });
  }
};

// ----------------------------------------------------------------------
// --- 3. MIDDLEWARE: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–ü–†–û–í–ï–†–ö–ê –†–û–õ–ò) ---
// ----------------------------------------------------------------------
/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∏–¥–ª–≤–∞—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 
 * –º–∞—Å—Å–∏–≤—É —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π.
 * @param roles - –ú–∞—Å—Å–∏–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, ['ADMIN']).
 */
export const authorize = (roles: string[]) => {

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∞–º –º–∏–¥–ª–≤–∞—Ä
  return (req: AuthRequest, res: Response, next: NextFunction) => {

    // 1. –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ protect —Å—Ä–∞–±–æ—Ç–∞–ª –∏ user.role –µ—Å—Ç—å
    if (!req.user || !req.user.role) {
      return res.status(403).json({ message: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–æ–ª–∏.' });
    }

    const userRole = req.user.role;

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö
    if (roles.includes(userRole)) {
      next(); // –†–æ–ª—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    } else {
      // –†–æ–ª—å –Ω–µ —Å–æ–≤–ø–∞–ª–∞
      return res.status(403).json({
        message: `–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è —Ä–æ–ª–∏: ${roles.join(', ')}.`
      });
    }
  };
};